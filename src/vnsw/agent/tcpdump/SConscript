# -*- mode: python; -*-
import os
import platform
import sys

libnl_dir = str(Dir('#/third_party/libnl-3.2.25/'))
libpcap_dir = str(Dir('#/third_party/libpcap-1.4.0/'))
tcpdump_dir  = str(Dir('#/third_party/tcpdump-4.4.0/'))
build_dir = str(Dir('#/build'))

env = DefaultEnvironment()
bin_dir = str(Dir('#/build/sbin/'))

config_opts = '--prefix=' + build_dir
libnl_opts = ' LDFLAGS=\"-L' + build_dir + '/lib\" CFLAGS=\"-I' + libnl_dir + '/include\" '

cmd = (
  'cd ' + libnl_dir + '; ' +   './configure ' + config_opts + '; make; make install;' +
  'cd ' + libpcap_dir + ';' + './configure ' + libnl_opts + config_opts +'; make; make install;' +
  'cd ' + tcpdump_dir + ';' + './configure ' + libnl_opts + config_opts +'; make; make install;' +
  'mv ' + bin_dir + '/tcpdump ' + bin_dir + '/contrail-tcpdump'
  )

binproducts = [ str(File('#/build/sbin/contrail-tcpdump')) ]

if not os.path.exists('#/build/sbin/contrail-tcpdump'):
    Execute(cmd)

env.Alias('install', env.Install(env['INSTALL_BIN'], binproducts))
