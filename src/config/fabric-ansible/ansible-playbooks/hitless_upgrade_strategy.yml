---
- name: Determine upgrade strategy and start sending upgrade batches

  hosts: localhost
  connection: local

  vars:
    image_upgrade_list: "{{playbook_input.input.image_devices}}"
    upgrade_mode: "{{playbook_input.input.upgrade_mode}}"
    batch_limit: "{{playbook_input.input.advanced_parameters.bulk_device_upgrade_count}}"
    output: {"status":"", "message":""}

  tasks:
    - set_fact:
        job_ctx: "{{job_ctx|combine({'total_task_count':1, 'task_weightage_array':[100] })}}"

    - name: Create hitless upgrade plan
      set_fact:
        upgrade_plan: "{{ job_ctx | hitless_upgrade_plan(image_upgrade_list, batch_limit) }}"

    - name: Print upgrade_plan
      debug:
        var: upgrade_plan

    - name: If test run, return all devices to job manager
      set_fact:
        first_batch: "{{ job_ctx | hitless_all_devices(upgrade_plan) }}"
      when: upgrade_mode == 'test_run'

    - name: Get first batch of devices and return to job manager
      set_fact:
        first_batch: "{{ job_ctx | hitless_next_batch(upgrade_plan, '') }}"
      when: upgrade_mode == 'upgrade'

    - block:
        - set_fact:
            op_err_message: "Failed to onboard fabric due to error: {{ output.error_msg }}"
            jl_err_message: "Failed to onboard fabric due to error: {{ output.error_msg }}"
            results: {}

        - name: Update job log with percentage
          include_tasks: percentage_update.yml
          vars:
            current_index: 1
            jl_message: "{{ jl_err_message }}"

        - pause: seconds=5

        - name: handle failure
          include_tasks: error_handler.yml
      when: output.status == 'failure'

#    - name: Update job log with percentage
#      include_tasks: percentage_update.yml
#      vars:
#        current_index: 1
#        jl_message: "Successfully created upgrade plan"

    - name: set output parameter
      set_fact:
         output: "{{ output|combine({'status':'SUCCESS', 'message':'Created upgrade plan', 'device_json': first_batch.next.batch_devices, 'upgrade_plan': upgrade_plan})}}"

    - name: Print output
      debug:
        var: output
