- name: Generate TFTP script file and sections of DHCP server config file
  hosts: localhost
  gather_facts: no
  connection: local

  roles:
    - ztp_config


- name: Copy ansible-created script files to TFTP server
  hosts: tftp
  gather_facts: no

  roles:
    - ztp_tftp


- name: Insert/update ansible-created section of DHCP server config file
  hosts: dhcp
  gather_facts: no

  roles:
    - ztp_dhcp


- name: Finish up on localhost
  hosts: localhost
  gather_facts: no
  connection: local
  
  tasks:
    - name: set output parameter
      set_fact:
        output: {'status':'SUCCESS', 'message':'ZTP playbook successfully executed'}

    - name: Get DHCP host
      set_fact:
        dhcp_host: "{{groups['dhcp'][0]}}"

    - name: Get DHCP results
      set_fact:
        dhcp_results: "{{hostvars[dhcp_host]['output']}}"

    - name: Set final output
      set_fact:
        output: "{{output | combine(dhcp_results)}}"

    - name: print output
      debug: var=output verbosity=1

#    - name: Update Job log with ZTP job completed status
#      job_objectlog:
#        job_ctx: "{{ job_ctx }}"
#        status: "{{ JOBLOG_STATUS.IN_PROGRESS }}"
#        message: "Finished ZTP"

