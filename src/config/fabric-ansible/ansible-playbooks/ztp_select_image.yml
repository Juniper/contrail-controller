---
- name: Select appropriate image for upgrade during ztp
  hosts: localhost
  gather_facts: no
  connection: local
  roles:
    - Juniper.junos

  vars:
    ztp_os_version: "{{playbook_input.input.os_version}}"
    pr_fq_name: "{{playbook_input.device_fqname[-1]}}"
    current_index: 0
    pr_product_name: "{{playbook_input.product_name}}"

  tasks:
    - block:
        - name: Set auto increment
          set_fact:
            percentage_auto_increment: true

        - name: Construct hardware name from product name
          set_fact:
            hardware_fq_name: ["juniper-{{pr_product_name}}"]

        - name: Read the hardware vnc object
          vnc_db_mod:
            job_ctx: "{{ job_ctx }}"
            object_type: "hardware"
            object_op: "read"
            object_dict: {"fq_name": "{{hardware_fq_name}}"}
          register: hardware_obj

        - name: Get the device image refs
          set_fact:
            image_refs: "{{hardware_obj.obj.device_image_refs}}"

        - name: Pick the right image
          include: image_validation.yml
          with_items:
          - "{{image_refs}}"
          when: image_uuid is not defined

        - name: Handle errors if no image is found
          include_tasks: error_handler.yml
          when: image_uuid is not defined
          vars:
            op_err_message: "No image with os version {{ztp_os_version}} that is compatible wih the device {{pr_fq_name}} was found"
            jl_err_message: "No image with os version {{ztp_os_version}} that is compatible wih the device {{pr_fq_name}} was found"

        - name: Call image upgrade
          include_role:
            name: image_upgrade_role
      when: ztp_os_version is defined

    - block:
        - name: Bump up the percentage to 100 if no os version is defined.
          set_fact:
            percent_init_dict: { 'total_task_count': 1, 'task_weightage_array': [100] }

        - set_fact:
            job_ctx: "{{job_ctx|combine(percent_init_dict)}}"

        - name: Update job log with percentage
          include_tasks: percentage_update.yml
          vars:
            current_index: 1
            jl_message: "Skippping image upgrade for device {{pr_fq_name}}"

        - name: Set the output
          set_fact:
            output: {'status':'Success', 'message':'Skipping image upgrade for device {{pr_fq_name}}'}
      when: ztp_os_version is not defined
