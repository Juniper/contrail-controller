---

- name: Push fabric config to device and read back facts
  hosts: localhost
  connection: local

  pre_tasks:
    - name: Call filter
      set_fact:
        render_output: "{{ job_ctx | render_fabric_config() }}"

    - set_fact:
        device_mgmt_ip: "{{ render_output.device_mgmt_ip }}"
        device_vendor: "{{ render_output.device_vendor }}"
        device_name: "{{ render_output.device_name }}"
        device_username: "{{ render_output.device_username }}"
        device_password: "{{ render_output.device_password }}"
        conf_dir: "{{ render_output.conf_dir }}"

  roles:
    - commit_fabric_config

  tasks:
    - set_fact:
        prouter_fqname: ['default-global-system-config', '{{ device_name }}' ]

    - name: PR objectlog update to set onboarding state
      prouter_objectlog:
        job_ctx: "{{ job_ctx }}"
        prouter_fqname: "{{ prouter_fqname }}"
        onboarding_state: "{{ DEVICE_STATE.UNDERLAY_CONFIGURED }}"
      when: input.is_delete is undefined or input.is_delete == False

    - name: Update job log with percentage
      include_tasks: percentage_update.yml
      vars:
        current_index: 2
        jl_message: "Underlay config successful for: {{device_mgmt_ip}}"

    - set_fact:
        output: {
              "status": "Success",
              "message": "Underlay config successful for: {{device_mgmt_ip}}"
          }

    - name: print output
      debug: var=output verbosity=1

