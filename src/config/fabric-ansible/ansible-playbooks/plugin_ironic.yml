---
- name: Checking if nodes are already available in Contrail-Command
  set_fact:
    output: "{{ playbook_input | check_nodes_with_cc(valid_ipmi_details) }}"
- debug:
    msg: "SERVER DISCOVERY: CHECK WITH CC {{ output }}"

- name: Registering node with Discovery Plugin
  set_fact:
    output: "{{ playbook_input | register_nodes(output.final_ipmi_details) }}"
  when:
    - output.status is defined
    - output.status == "success"
    - output.final_ipmi_details is defined
    - output.final_ipmi_details| length > 0

- debug:
    msg: "SERVER DISCOVERY: REGISTERED NODES {{ output.nodes }}"

- name: Triggering Hardware inspection with Discovery plugin
  set_fact:
    output: "{{ playbook_input | trigger_introspect(output.nodes ) }}"
  when:
    - playbook_input.input.ironic.introspection_flag | default('yes') | bool
    - output.status is defined
    - output.status == "success"
    - output.nodes is defined
    - output.nodes | length > 0

- debug:
    msg: "SERVER DISCOVERY: TRIGGERED NODES {{ output.nodes}}"

- name: Importing nodes with Contrail-Command
  set_fact:
    output : "{{ playbook_input | import_ironic_nodes(output.nodes)}}"
  when:
    - output.status is defined
    - output.status == "success"
    - output.nodes is defined
    - output.nodes | length > 0

- debug:
    msg: "SERVER DISCOVERY: IMPORTED NODES {{ output.success_nodes }}"
