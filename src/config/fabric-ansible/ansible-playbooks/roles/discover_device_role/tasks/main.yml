---
# tasks file for discover_device_role

    - name: get device info
      device_info:
        job_ctx: "{{ job_ctx }}"
        credentials: "{{ credentials }}"
        subnets: "{{ host_prefix }}"
        version: "v2c"
        community: "public"
        device_family_info: "{{ device_family_info }}"
      register: mapped_devices

    - debug: var=mapped_devices

    - name: form a list of dicts for PR create
      set_fact:
        all_device_info: |
          {%- set devices_payloads = []                                         %}
          {%- for info in mapped_devices.device_info                            %}
          {%-     set device_payload = {}                                       %}
          {%-     set x=device_payload.update({
                                               "parent_type": "global-system-config",
                                               "fq_name": ["default-global-system-config", info.hostname],
                                               "physical_router_management_ip": info.host,
                                               "physical_router_vendor_name": info.vendor,
                                               "physical_router_product_name": info.product,
                                               "physical_router_device_family": info.family,
                                               }) %}
          {%-     if "username" and "password" in info                        %}
          {%-         set x=device_payload.update({
                                                  "physical_router_user_credentials": {
                                                   "username": info.username,
                                                   "password": info.password }
                                                  }) %}
          {%-     endif %}
          {%-     set y=devices_payloads.append(device_payload)               %}
          {%- endfor %}
          {"all_device_payloads": {{devices_payloads|tojson}} }

    - set_fact:
        pr_create_payload: "{{all_device_info.all_device_payloads}}"

    - debug: var=pr_create_payload

    - name: bulk create PR object
      vnc_db_mod:
        job_ctx: "{{ job_ctx }}"
        object_type: "physical_router"
        object_op: "bulk_create"
        object_list: "{{pr_create_payload}}"
      register: bulk_create_log_int_resp

    - name: PR objectlog update to set the onboarding state
      prouter_objectlog:
        prouter_fqname: ["default-global-system-config", "{{ item.hostname }}"]
        onboarding_state: "{{ DEVICE_STATE.DISCOVERED }}"
        job_ctx: "{{ job_ctx }}"
      with_items: "{{ mapped_devices.device_info }}"

