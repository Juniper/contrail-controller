#Playbook to deactivate maintenance mode on device.


- name: Deactivate maintenance mode on device {{pr_name}}
  set_fact:
    device_maintenance_mode: "deactivate"

# Commeit the deactivation config
- include_role:
    name: "maintenance_mode_config_push"

- name: Check health of the device after deactivation of maintenance mode
  include_role:
    name: device_health_check
  vars:
    snap_test_pfx: "juniper_snapshot_1"
    snap_action: "snap_post"


#- name: Compare the snapshots  # add retry logic, set fact to use appropriate temaplets for health check
#  include_role:
#    name: device_health_check
#  vars:
#    snap_test_pfx: "juniper_check_maintenance_mode"
#    snap_action: "snapcheck"

#
#- name: PR objectlog update to set completion of maintenance_mode
#  prouter_objectlog:
#    job_ctx: "{{ job_ctx }}"
#    prouter_fqname: "{{ prouter_fqname }}"
#    onboarding_state: "{{ DEVICE_STATE.EXITING_MAINTENANCE_MODE }}"


- name: Get next batch of devices and return to job manager
  set_fact:
    next_batch: "{{ job_ctx | hitless_next_batch(upgrade_plan, prouter_uuid)}}"
