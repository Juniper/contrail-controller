set groups {{cfg_group}} routing-options forwarding-table chained-composite-next-hop ingress evpn
set groups {{cfg_group}} policy-options policy-statement type5_policy term 1 from protocol direct
set groups {{cfg_group}} policy-options policy-statement type5_policy term 1 then accept
set groups {{cfg_group}} policy-options policy-statement type5_policy term 2 from protocol static
set groups {{cfg_group}} policy-options policy-statement type5_policy term 2 then accept
set groups {{cfg_group}} policy-options policy-statement type5_policy term 3 from protocol evpn
set groups {{cfg_group}} policy-options policy-statement type5_policy term 3 from route-filter 0.0.0.0/0 prefix-length-range /32-/32
set groups {{cfg_group}} policy-options policy-statement type5_policy term 3 then accept
{% set dummy_ip = device_abstract_config.get('system', {}).get('dummy_ip') %}
{%     for ri in device_abstract_config.get('routing_instances', []) %}
{%         set name = ri.get('description', '')[:127] %}
{%         set vxlan_id = ri.get('vxlan_id', '') %}
{%         if vxlan_id == 'None' %}
{%             set vxlan_id = ri.get('virtual_network_id') %}
{%         endif %}
{%         if (ri.get('virtual_network_is_internal') == true) and ('vrf' in ri.get('routing_instance_type', '')) and (ri.get('is_master') == true) %}{# /* BGP for master_LR */ #}
{%             for route in ri.get('static_routes', []) %}
{%                 set cidr = route.get('prefix') %}
{%                 set next_hop = route.get('next_hop') %}
set groups {{cfg_group}} routing-options static route {{cidr}} next-hop {{next_hop}}
{%                 set bfd = route.get('bfd', {}) %}
{%                 if bfd|length > 0 %}
{%                     set rx_tx_interval = bfd.get('rx_tx_interval') %}
{%                     set detection_time_multiplier = bfd.get('detection_time_multiplier') %}
set groups {{cfg_group}} routing-options static route {{cidr}} next-hop {{next_hop}} bfd-liveness-detection minimum-interval {{rx_tx_interval}}
set groups {{cfg_group}} routing-options static route {{cidr}} next-hop {{next_hop}} bfd-liveness-detection multiplier {{detection_time_multiplier}}
{%                 endif %}
{%             endfor %}
{%             set ospf_ns = namespace(advloop=false) %}
{%             for protocols in ri.get('protocols', []) %}
{%                 for bgp in protocols.get('bgp', []) %}
{%                     set bgp_name = bgp.get('name') %}
{%                     set bgp_local_as = bgp.get('autonomous_system') %}
{%                     set bgp_auth_key = bgp.get('authentication_key', '') %}
{%                     set multihop = bgp.get('multihop', {}) %}
{%                     if bgp_auth_key != '' %}
set groups {{cfg_group}} protocols bgp group {{bgp_name}} authentication-key {{bgp_auth_key}}
{%                     endif %}
set groups {{cfg_group}} protocols bgp path-selection external-router-id
set groups {{cfg_group}} protocols bgp group {{bgp_name}} type external
set groups {{cfg_group}} protocols bgp group {{bgp_name}} local-as {{bgp_local_as}} loops 2
{%                     set bf_global_asn = device_abstract_config.get('system', {}).get('brownfield_global_asn', '') %}
{%                     if bf_global_asn == bgp_local_as %}
set groups __contrail_overlay_bgp__ protocols bgp group _contrail_asn-{{bf_global_asn}} local-as {{bf_global_asn}} loops 2
set groups __contrail_overlay_bgp__ routing-options autonomous-system loops 2
{%                     endif %}
{%                     if multihop|length > 0 %}
{%                         set multihop_ttl = multihop.get('ttl', 0) %}
{%                         if multihop_ttl > 0 %}
set groups {{cfg_group}} protocols bgp group {{bgp_name}} multihop ttl {{multihop_ttl}}
{%                         endif %}
{%                     endif %}
{%                     set local_ip = bgp.get('ip_address', '') %}
{%                     if local_ip != '' %}
set groups {{cfg_group}} protocols bgp group {{bgp_name}} local-address {{local_ip}}
{%                     endif %}
set groups {{cfg_group}} protocols bgp group {{bgp_name}} multipath
{%                     for peer in bgp.get('peers', []) %}
{%                         set peer_ip = peer.get('ip_address') %}
{%                         set peer_as = peer.get('autonomous_system') %}
set groups {{cfg_group}} protocols bgp group {{bgp_name}} neighbor {{peer_ip}} peer-as {{peer_as}}
{%                     endfor %}
{%                     set bfd = bgp.get('bfd', {}) %}
{%                     if bfd|length > 0 %}
{%                         set rx_tx_interval = bfd.get('rx_tx_interval') %}
{%                         set detection_time_multiplier  = bfd.get('detection_time_multiplier') %}
set groups {{cfg_group}} protocols bgp group {{bgp_name}} bfd-liveness-detection minimum-interval {{rx_tx_interval}}
set groups {{cfg_group}} protocols bgp group {{bgp_name}} bfd-liveness-detection multiplier {{detection_time_multiplier}}
{%                     endif %}
{%                     set rp = bgp.get('routing_policies', {}) %}
{%                     if rp|length > 0 %}
{%                         for import_rp in rp.get('import_routing_policies', []) %}
{%                             if import_rp != '' %}
set groups {{cfg_group}} protocols bgp group {{bgp_name}} import {{import_rp}}
{%                             endif %}
{%                         endfor %}
{%                         for export_rp in rp.get('export_routing_policies', []) %}
{%                             if export_rp != '' %}
set groups {{cfg_group}} protocols bgp group {{bgp_name}} export {{export_rp}}
{%                             endif %}
{%                         endfor %}
{%                     endif %}{# /* bgp has routing policies */ #}
{%                 endfor %}{# /* end of bgp for loop */ #}
{%                 set ns = namespace(pim_found=false) %}
{%                 for pim in protocols.get('pim', []) %}
{%                     set ns.pim_found = true %}
{%                     set rp_list = pim.get('rp', []) %}
{%                     set intf_list = pim.get('pim_interfaces', '') %}
{%                     set eoai = pim.get('enable_on_all_interfaces', false) %}
{%                     set mode = pim.get('mode') %}
{%                     set bfd  = pim.get('bfd', {}) %}
{%                     if rp_list|length > 0 %}
{%                         for rp_ip in rp_list %}
set groups {{cfg_group}} protocols pim rp static address {{rp_ip}}
{%                         endfor %} {# /* end for rp list */ #}
{%                     endif %} {# /* endif for rp */ #}
{%                     for intf in intf_list %}
set groups {{cfg_group}} protocols pim interface {{intf.interface.name}}  mode {{mode}}
{%                         if bfd|length > 0 %}
{%                            set rx_tx_interval = bfd.get('rx_tx_interval') %}
{%                            set detection_time_multiplier = bfd.get('detection_time_multiplier') %}
set groups {{cfg_group}} protocols pim interface {{intf.interface.name}} family inet bfd-liveness-detection minimum-interval {{rx_tx_interval}}
set groups {{cfg_group}} protocols pim interface {{intf.interface.name}} family inet bfd-liveness-detection multiplier {{detection_time_multiplier}}
{%                         endif %} {# /* endif for bfd */ #}
{%                     endfor %} {# /* endif for pim intf */ #}
{%                 endfor %} {# /* end for proto pim */ #}
{%                 if ns.pim_found == true %}
{%                     for irb_intfs in ri.get('routing_interfaces', []) %}
{%                 	   set irb_name = irb_intfs.get('name') %}
set groups {{cfg_group}} protocols igmp interface {{irb_name}}
{%                     endfor %}
{%                 endif %} {# end of if pim configured in RI #}
{%                 for ospf in protocols.get('ospf', []) %}
{%                     set area_id = ospf.get('area_id', '') %}
{%                     set intf = ospf.get('interface', '') %}
{%                     set area_type = ospf.get('area_type') %}
{%                     set advertise_loop = ospf.get('advertise_loopback', false) %}
{%                     set rp = ospf.get('routing_policies', {}) %}
{%                     if rp|length > 0 %}
{%                         for import_rp in rp.get('import_routing_policies', []) %}
{%                             if import_rp != '' %}
set groups {{cfg_group}} protocols ospf import {{import_rp}}
{%                             endif %}
{%                         endfor %}
{%                         for export_rp in rp.get('export_routing_policies', []) %}
{%                             if export_rp != '' %}
set groups {{cfg_group}} protocols ospf export {{export_rp}}
{%                             endif %}
{%                         endfor %}
{%                     endif %}{# /* ospf routing policies */ #}
{%                     if area_id != '0.0.0.0' and area_id != '0' %}
{%                         if area_type == 'nssa' %}
{%                             if ospf.get('orignate_summary_lsa', false) == true %}
set groups {{cfg_group}} protocols ospf area {{area_id}} nssa default-lsa default-metric 10
{%                             else %}
set groups {{cfg_group}} protocols ospf area {{area_id}} nssa no-summaries
{%                             endif %}
{%                         elif area_type == 'stub' %}
{%                             if ospf.get('orignate_summary_lsa', false) == true %}
set groups {{cfg_group}} protocols ospf area {{area_id}} stub default-metric 10
{%                             else %}
set groups {{cfg_group}} protocols ospf area {{area_id}} stub default-metric 10 no-summaries
{%                             endif %}
{%                         endif %}
{%                     endif %} {# /* end of ospf area id */ #}
{%                     if (advertise_loop == true) and (ospf_ns.advloop == false) %}
{%                         set ospf_ns.advloop = true %}
set groups {{cfg_group}} protocols ospf area {{area_id}} interface lo0.0 passive
{%                     endif %}
{%                     set interface_type = ospf.get('interface_type', '') %}
{%                     if interface_type != '' %}
set groups {{cfg_group}} protocols ospf area {{area_id}} interface {{intf}} interface-type p2p
{%                     endif %}
{%                     set ospf_auth_key = ospf.get('authentication_key', '') %}
{%                     if ospf_auth_key != '' %}
set groups {{cfg_group}} protocols ospf area {{area_id}} interface {{intf}} authentication md5 5 key {{ospf_auth_key}}
{%                     endif %}
{%                     set hello_intv = ospf.get('hello_interval', 0) %}
{%                     set dead_intv = ospf.get('dead_interval', 0) %}
{%                     if hello_intv != 0 %}
set groups {{cfg_group}} protocols ospf area {{area_id}} interface {{intf}} hello-interval {{hello_intv}}
{%                     endif %}
{%                     if dead_intv != 0 %}
set groups {{cfg_group}} protocols ospf area {{area_id}} interface {{intf}} dead-interval {{dead_intv}}
{%                     endif %}
{%                     set bfd  = ospf.get('bfd', {}) %}
{%                     if bfd|length > 0 %}
{%                         set rx_tx_interval = bfd.get('rx_tx_interval') %}
{%                         set detection_time_multiplier = bfd.get('detection_time_multiplier') %}
set groups {{cfg_group}} protocols ospf area {{area_id}} interface {{intf}} bfd-liveness-detection minimum-interval {{rx_tx_interval}}
set groups {{cfg_group}} protocols ospf area {{area_id}} interface {{intf}} bfd-liveness-detection multiplier  {{detection_time_multiplier}}
{%                     endif %} {# /* endif for OSPF BFD*/ #}
{%                 endfor %} {# /* end of OSPF loop */ #}
{%             endfor %}{# /* end of protocols for loop */ #}
{%         endif %}{# /* virtual_network_is_internal */ #}
{%         if (ri.get('virtual_network_is_internal') == true) and ('vrf' in ri.get('routing_instance_type', '')) and (ri.get('is_master') != true) %}
{%             for lo_int in ri.get('loopback_interfaces', []) %}
{%                 set loopback_intf_name = lo_int.get('name', '') %}
{%                 for pi in device_abstract_config.get('physical_interfaces', []) %}
{%                     if pi.get('interface_type', '') == 'loopback' %}
{%                         for li in pi.get('logical_interfaces', []) %}
{%                             set int_name = li.get('name', '') %}
{%                             if int_name == loopback_intf_name %}
{%                                 set unit_num = int_name.split('.')[-1] %}
{%                                 set addresses = li.get('ip_addresses',[]) %}
{%                                 for address in addresses or [] %}
{%                                     set addr = address.get('address','') + '/32' %}
set groups {{cfg_group}} interfaces lo0 unit {{unit_num}} family inet address {{ addr }}
set groups {{cfg_group}} routing-instances {{name}} interface {{int_name}}
{%                                 endfor %} {# /* end for LI address loop */ #}
{%                             endif %} {# /* endif for interface name check  */ #}
{%                         endfor %} {# /* end for LI in physical interfaces  */ #}
{%                     endif %} {# /* endif  interface type loopback */ #}
{%                 endfor %} {# /* end for physical interfaces loop */ #}
{%             endfor %} {# /* end for loopback interfaces loop */ #}
set groups {{cfg_group}} routing-instances {{name}} routing-options multipath
set groups {{cfg_group}} routing-instances {{name}} routing-options rib {{name}}.inet6.0 multipath
set groups {{cfg_group}} routing-instances {{name}} routing-options static route {{dummy_ip}}/32 discard
{%             if (vxlan_id != '') %}
set groups {{cfg_group}} protocols evpn default-gateway no-gateway-community
set groups {{cfg_group}} routing-instances {{name}} protocols evpn ip-prefix-routes advertise direct-nexthop
set groups {{cfg_group}} routing-instances {{name}} protocols evpn ip-prefix-routes encapsulation vxlan
set groups {{cfg_group}} routing-instances {{name}} protocols evpn ip-prefix-routes vni {{vxlan_id}}
set groups {{cfg_group}} routing-instances {{name}} protocols evpn ip-prefix-routes export type5_policy
{%             endif %}
set groups {{cfg_group}} routing-instances {{name}} instance-type vrf
{%             set vrf_import = name+'-import' %}
{%             set vrf_export = name+'-export' %}
set groups {{cfg_group}} routing-instances {{name}} vrf-import {{vrf_import}}
set groups {{cfg_group}} routing-instances {{name}} vrf-export {{vrf_export}}
{%             if ri.get('virtual_network_is_shared', '') == true %}
set groups {{cfg_group}} routing-instances {{name}} routing-options auto-export
{%             endif %}
{%             for irb_int in ri.get('routing_interfaces', []) %}
{%                 set irb_name = irb_int.get('name') %}
set groups {{cfg_group}} routing-instances {{name}} interface {{irb_name}}
{%             endfor %}
{%             for route in ri.get('static_routes', []) %}
{%                 if 'Routed VN static route' in route.get('comment','') %}
{%                     set cidr = route.get('prefix') %}
{%                     set next_hop = route.get('next_hop') %}
set groups {{cfg_group}} routing-instances {{name}} routing-options static route {{cidr}} next-hop {{next_hop}}
{%                     set bfd = route.get('bfd', {}) %}
{%                     if bfd|length > 0 %}
{%                         set rx_tx_interval = bfd.get('rx_tx_interval') %}
{%                         set detection_time_multiplier = bfd.get('detection_time_multiplier') %}
set groups {{cfg_group}} routing-instances {{name}} routing-options static route {{cidr}} next-hop {{next_hop}} bfd-liveness-detection minimum-interval {{rx_tx_interval}}
set groups {{cfg_group}} routing-instances {{name}} routing-options static route {{cidr}} next-hop {{next_hop}} bfd-liveness-detection multiplier {{detection_time_multiplier}}
{%                     endif %}
{%                 endif %}
{%             endfor %}
{%             set ospf_ns = namespace(advloop=false) %}
{%             for protocols in ri.get('protocols', []) %}
{%                 for bgp in protocols.get('bgp', []) %}
{%                     if 'Routed VN BGP info' in bgp.get('comment','') %}
{%                         set bgp_name = bgp.get('name') %}
{%                         set bgp_local_as = bgp.get('autonomous_system') %}
{%                         set bgp_auth_key = bgp.get('authentication_key', '') %}
{%                         set multihop = bgp.get('multihop', {}) %}
{%                         if bgp_auth_key != '' %}
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} authentication-key {{bgp_auth_key}}
{%                         endif %}
set groups {{cfg_group}} routing-instances {{name}} protocols bgp path-selection external-router-id
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} type external
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} local-as {{bgp_local_as}} loops 2
{%                         set bf_global_asn = device_abstract_config.get('system', {}).get('brownfield_global_asn', '') %}
{%                         if bf_global_asn == bgp_local_as %}
set groups __contrail_overlay_bgp__ protocols bgp group _contrail_asn-{{bf_global_asn}} local-as {{bf_global_asn}} loops 2
set groups __contrail_overlay_bgp__ routing-options autonomous-system loops 2
{%                         endif %}
{%                         if multihop|length > 0 %}
{%                             set multihop_ttl = multihop.get('ttl', 0) %}
{%                             if multihop_ttl > 0 %}
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} multihop ttl {{multihop_ttl}}
{%                             endif %}
{%                         endif %}
{%                         set local_ip = bgp.get('ip_address', '') %}
{%                         if local_ip != '' %}
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} local-address {{local_ip}}
{%                         endif %}
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} multipath
{%                         for peer in bgp.get('peers', []) %}
{%                             set peer_ip = peer.get('ip_address') %}
{%                             set peer_as = peer.get('autonomous_system') %}
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} neighbor {{peer_ip}} peer-as {{peer_as}}
{%                         endfor %}
{%                         set bfd = bgp.get('bfd', {}) %}
{%                         if bfd|length > 0 %}
{%                             set rx_tx_interval = bfd.get('rx_tx_interval') %}
{%                             set detection_time_multiplier  = bfd.get('detection_time_multiplier') %}
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} bfd-liveness-detection minimum-interval {{rx_tx_interval}}
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} bfd-liveness-detection multiplier {{detection_time_multiplier}}
{%                         endif %}
{%                         set rp = bgp.get('routing_policies', {}) %}
{%                         if rp|length > 0 %}
{%                             for import_rp in rp.get('import_routing_policies', []) %}
{%                                 if import_rp != '' %}
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} import {{import_rp}}
{%                                 endif %}
{%                             endfor %}
{%                             for export_rp in rp.get('export_routing_policies', []) %}
{%                                 if export_rp != '' %}
set groups {{cfg_group}} routing-instances {{name}} protocols bgp group {{bgp_name}} export {{export_rp}}
{%                                 endif %}
{%                             endfor %}
{%                         endif %}{# /* bgp has routing policies */ #}
set groups {{cfg_group}} routing-instances {{name}} protocols evpn ip-prefix-routes export BGP_ROUTES
set groups {{cfg_group}} policy-options policy-statement BGP_ROUTES term DEFAULT_BGP from protocol bgp
set groups {{cfg_group}} policy-options policy-statement BGP_ROUTES term DEFAULT_BGP then accept
{%                     endif %}
{%                 endfor %}{# /* end of bgp for loop */ #}
{%                 set ns = namespace(pim_found=false) %}
{%                 for pim in protocols.get('pim', []) %}
{%                     if 'Routed VN PIM info' in pim.get('comment','') %}
{%                         set ns.pim_found = true %}
{%                         set rp_list = pim.get('rp', []) %}
{%                         set intf_list = pim.get('pim_interfaces', []) %}
{%                         set eoai = pim.get('enable_on_all_interfaces', false) %}
{%                         set mode = pim.get('mode') %}
{%                         set bfd  = pim.get('bfd', {}) %}
{%                         if rp_list|length > 0 %}
{%                             for rp_ip in rp_list %}
set groups {{cfg_group}} routing-instances {{name}} protocols pim rp static address {{rp_ip}}
{%                             endfor %} {# /* end for rp list */ #}
{%                         endif %} {# /* endif for rp */ #}
{%                         for intf in intf_list %}
set groups {{cfg_group}} routing-instances {{name}} protocols pim interface {{intf.interface.name}}  mode {{mode}}
{%                             if bfd|length > 0 %}
{%                                 set rx_tx_interval = bfd.get('rx_tx_interval') %}
{%                                 set detection_time_multiplier = bfd.get('detection_time_multiplier') %}
set groups {{cfg_group}} routing-instances {{name}} protocols pim interface {{intf.interface.name}} family inet bfd-liveness-detection minimum-interval {{rx_tx_interval}}
set groups {{cfg_group}} routing-instances {{name}} protocols pim interface {{intf.interface.name}} family inet bfd-liveness-detection multiplier {{detection_time_multiplier}}
{%                             endif %} {# /* endif for bfd */ #}
{%                         endfor %} {# /* endif for pim intf */ #}
{%                     endif %} {# /* endif for pim comment */ #}
{%                 endfor %} {# /* end for proto pim */ #}
{%                 if ns.pim_found == true %}
{%                     for irb_intfs in ri.get('routing_interfaces', []) %}
{%                 	   set irb_name = irb_intfs.get('name') %}
set groups {{cfg_group}} protocols igmp interface {{irb_name}}
{%                     endfor %}
{%                 endif %} {# end of if pim configured in RI #}
{%                 for ospf in protocols.get('ospf', []) %}
{%                     if 'Routed VN OSPF info' in ospf.get('comment','') %}
{%                         set area_id = ospf.get('area_id', '') %}
{%                         set intf = ospf.get('interface', '') %}
{%                         set area_type = ospf.get('area_type') %}
{%                         set advertise_loop = ospf.get('advertise_loopback', false) %}
{%                         set rp = ospf.get('routing_policies', {}) %}
{%                         if rp|length > 0 %}
{%                             for import_rp in rp.get('import_routing_policies', []) %}
{%                                 if import_rp != '' %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf import {{import_rp}}
{%                                 endif %}
{%                             endfor %}
{%                             for export_rp in rp.get('export_routing_policies', []) %}
{%                                 if export_rp != '' %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf export {{export_rp}}
{%                                 endif %}
{%                             endfor %}
{%                         endif %}{# /* ospf routing policies */ #}
set groups {{cfg_group}} routing-instances {{name}} protocols evpn ip-prefix-routes export OSPF_ROUTES
set groups {{cfg_group}} policy-options policy-statement OSPF_ROUTES term DEFAULT_OSPF from protocol ospf
set groups {{cfg_group}} policy-options policy-statement OSPF_ROUTES term DEFAULT_OSPF then accept
{%                         if area_id != '0.0.0.0' and area_id != '0' %}
{%                             if area_type == 'nssa' %}
{%                                 if ospf.get('orignate_summary_lsa', false) == true %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} nssa default-lsa default-metric 10
{%                                 else %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} nssa no-summaries
{%                                 endif %}
{%                             elif area_type == 'stub' %}
{%                                 if ospf.get('orignate_summary_lsa', false) == true %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} stub default-metric 10
{%                                 else %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} stub default-metric 10 no-summaries
{%                                 endif %}
{%                             endif %}
{%                         endif %}
{%                         if (advertise_loop == true) and (ospf_ns.advloop == false) %}
{%                             set ospf_ns.advloop = true %}
{%                             set loopback_intfs = ri.get('loopback_interfaces', []) %}
{%                             set lo_intf = loopback_intfs[-1].get('name','') %}
{%                             if lo_intf != '' %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} interface {{lo_intf}} passive
{%                             endif %}
{%                         endif %}
{%                         set interface_type = ospf.get('interface_type', '') %}
{%                         if interface_type != '' %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} interface {{intf}} interface-type p2p
{%                         endif %}
{%                         set ospf_auth_key = ospf.get('authentication_key', '') %}
{%                         if ospf_auth_key != '' %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} interface {{intf}} authentication md5 5 key {{ospf_auth_key}}
{%                         endif %}
{%                         set hello_intv = ospf.get('hello_interval', 0) %}
{%                         set dead_intv = ospf.get('dead_interval', 0) %}
{%                         if hello_intv != 0 %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} interface {{intf}} hello-interval {{hello_intv}}
{%                         endif %}
{%                         if dead_intv != 0 %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} interface {{intf}} dead-interval {{dead_intv}}
{%                         endif %}
{%                         set bfd  = ospf.get('bfd', {}) %}
{%                         if bfd|length > 0 %}
{%                             set rx_tx_interval = bfd.get('rx_tx_interval') %}
{%                             set detection_time_multiplier = bfd.get('detection_time_multiplier') %}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} interface {{intf}} bfd-liveness-detection minimum-interval {{rx_tx_interval}}
set groups {{cfg_group}} routing-instances {{name}} protocols ospf area {{area_id}} interface {{intf}} bfd-liveness-detection multiplier  {{detection_time_multiplier}}
{%                         endif %} {# /* endif for OSPF BFD*/ #}
{%                     endif %} {# /* end of OSPF comment loop */ #}
{%                 endfor %} {# /* end of OSPF loop */ #}
{%             endfor %}{# /* end of protocols for loop */ #}
{%         endif %}{# /* virtual_network_is_internal */ #}
{%         for verbs in ["vrf_export", "vrf_import"] %}
{%             for vrf_rp in ri.get(verbs, []) %}
{%                 if verbs == "vrf_export" %}
set groups {{cfg_group}} routing-instances {{name}} vrf-export {{vrf_rp}}
{%                 else %}
set groups {{cfg_group}} routing-instances {{name}} vrf-import {{vrf_rp}}
{%                 endif %}
{%             endfor %}
{%         endfor %}
{%     endfor %}{# /* routing instances */ #}
{%     for rp in device_abstract_config.features.get('vn-interconnect').get('routing_protocols', []) %}
{%         for igmp_snoop in rp.get('igmp_snooping', []) %}
{%             for vlan in igmp_snoop.get('vlans', []) %}
{%                 set vlan_name = vlan.get('name', '') %}
set groups {{cfg_group}} protocols igmp-snooping vlan all
set groups {{cfg_group}} protocols igmp-snooping vlan {{vlan_name}}
{%                 for intf in vlan.get('interfaces', []) %}
{%                     set intf_name = intf.get('name', '') %}
set groups {{cfg_group}} protocols igmp-snooping vlan {{vlan_name}} interface {{intf_name}}
{%                 endfor %}
{%             endfor %}
{%         endfor %} {# /* end for igmp snooping*/ #}
{%     endfor %} {# /* end for routing-protocols */ #}
{%     for rp in device_abstract_config.get('routing_policies', []) %}
{%         set rp_entery = rp.get('routing_policy_entries', {}) %}
{%         if rp_entery|length > 0 %}
{%             set rp_name = rp.get('name', '') %}
{%             for term in rp_entery.get('terms', []) %}
{%                 set tname = 'T' + loop.index|string %}
{%                 set tcond = term.get('term_match_condition', {}) %}
{%                 set taction = term.get('term_action_list', {}) %}
{%                 if ((tcond|length > 0) or (taction|length > 0)) %}
{%                     if (tcond|length > 0) %}
{%                         for protocol in tcond.get('protocol', []) %}
{%                             if ((protocol == 'interface') or (protocol == 'interface-static')) %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from protocol direct
{%                             else %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from protocol {{protocol}}
{%                             endif %}
{%                         endfor %}{# /* protocol */ #}
{%                         for extcom in tcond.get('extcommunity_list', []) %}
{%                             set cname = rp_name + '-' + tname + '-C' + loop.index|string %}
set groups {{cfg_group}} policy-options community {{cname}} members {{extcom | rtfilter}}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from community {{cname}}
{%                         endfor %}{# /* extcommunity_list */ #}
{%                         set fprefixs = [] %}
{%                         for prefix in tcond.get('prefix', []) %}
{%                             set z = fprefixs.append(prefix) %}
{%                         endfor %}
{%                         set fcommunity = tcond.get('community', '') %}
{%                         set fcommunity_list = tcond.get('community_list', []) %}
{%                         set ffamily = tcond.get('family', '') %}
{%                         set fas_path_list = tcond.get('as_path', []) %}
{%                         set fexternal = tcond.get('external', '') %}
{%                         set flocal_pref = tcond.get('local_pref', '') %}
{%                         set fnlri_route_types = tcond.get('nlri_route_type', []) %}
{%                         set fprefix_lists = tcond.get('prefix_list', []) %}
{%                         set froute_filter = tcond.get('route_filter', None) %}
{%                         if fcommunity != '' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from community {{fcommunity}}
{%                             for fcom_member in fcommunity_list %}
set groups {{cfg_group}} policy-options community {{fcommunity}} members {{fcom_member | rtfilter}}
{%                             endfor %}
{%                         endif %}
{%                         if (fnlri_route_types|length > 0) and (ffamily != 'evpn') %}
{%                             set ffamily = 'evpn' %}
{%                         endif %}
{%                         if ffamily != '' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from family {{ffamily}}
{%                         endif %}
{%                         for fas_pathv in fas_path_list %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from as-path {{fas_pathv}}
{%                         endfor %}
{%                         if fexternal == 'ospf-type-1' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from external type 1
{%                         elif fexternal == 'ospf-type-2' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from external type 2
{%                         endif %}
{%                         if flocal_pref != '' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from local-preference {{flocal_pref}}
{%                         endif %}
{%                         for fnlri_route_type in fnlri_route_types %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from nlri-route-type {{fnlri_route_type}}
{%                         endfor %}
{%                         for fprefix_list in fprefix_lists %}
{%                             set prefixtype = fprefix_list.get('prefix_type', '') %}
{%                             set pvalue_prefixes = fprefix_list.get('prefixes', []) %}
{%                             for pvalue_prefixe in pvalue_prefixes %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from route-filter {{pvalue_prefixe}} {{prefixtype}}
{%                             endfor %}
{%                         endfor %}
{%                         if froute_filter != None %}
{%                             for frf_prop in froute_filter.get('route_filter_properties', []) %}
{%                                 set route = frf_prop.get('route', '') %}
{%                                 set route_type = frf_prop.get('route_type', '') %}
{%                                 set rtv = frf_prop.get('route_type_value', '') %}
{%                                 if rtv != '' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from route-filter {{route}} {{route_type}} {{rtv}}
{%                                 else %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from route-filter {{route}} {{route_type}}
{%                                 endif %}
{%                             endfor %}
{%                         endif %}
{%                         for fprefix in fprefixs %}
{%                             set ptype = fprefix.get('prefix_type', '') %}
{%                             set pvalue = fprefix.get('prefix', '') %}
{%                             if pvalue != '' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} from route-filter {{pvalue}} {{ptype}}
{%                             endif %}
{%                         endfor %}{# /* fprefixs */ #}
{%                     endif %}{# /* from clause - tcond */ #}
{%                     if (taction|length > 0) %}
{%                         set tcommunity = taction.get('community', '') %}
{%                         set tcommunity_list = taction.get('community_list', []) %}
{%                         set texternal = taction.get('external', '') %}
{%                         set term_action = taction.get('action', '') %}
{%                         set tupdate = taction.get('update', '') %}
{%                         set tas_path_expand = taction.get('as_path_expand', '') %}
{%                         set tas_path_prepend = taction.get('as_path_prepend', '') %}
{%                         if tcommunity != '' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} then community add {{tcommunity}}
{%                             for tcom_member in tcommunity_list %}
set groups {{cfg_group}} policy-options community {{tcommunity}} members {{tcom_member | rtfilter}}
{%                             endfor %}
{%                         endif %}
{%                         if tupdate != '' %}
{%                             set tupdate_comm = tupdate.get('community', None) %}
{%                             if tupdate_comm != None %}
{%                                 for verb in ["add", "remove", "set"] %}
{%                                     set tverb = tupdate_comm.get(verb, None) %}
{%                                     if tverb != None %}
{%                                         for tcom_value in tverb.get('community', []) %}
{%                                             set cname = rp_name + '-' + tname + '-C' + verb + loop.index|string %}
set groups {{cfg_group}} policy-options community {{cname}} members {{tcom_value | rtfilter}}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} then community {{verb}} {{cname}}
{%                                         endfor %}
{%                                     endif %}
{%                                 endfor %}
{%                             endif %}{# /* then community add-remove-set clause */ #}
{%                             set tupdate_extcomm = tupdate.get('extcommunity', None) %}
{%                             if tupdate_extcomm != None %}
{%                                 for verb in ["add", "remove", "set"] %}
{%                                     set tverb = tupdate_extcomm.get(verb, None) %}
{%                                     if tverb != None %}
{%                                         for tcom_value in tverb.get('community', []) %}
{%                                             set cname = rp_name + '-' + tname + '-EXTC' + verb + loop.index|string %}
set groups {{cfg_group}} policy-options community {{cname}} members {{tcom_value | rtfilter}}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} then community {{verb}} {{cname}}
{%                                         endfor %}
{%                                     endif %}
{%                                 endfor %}
{%                             endif %}{# /* then extcommunity add-remove-set clause */ #}
{%                             set localpref = tupdate.get('local_pref', '') %}
{%                             set as_path = tupdate.get('as_path', '') %}
{%                             if localpref != '' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} then local-preference {{localpref}}
{%                             endif %}
{%                             if as_path != '' %}
{%                                 set expand = as_path.get('expand', '') %}
{%                                 if expand != '' %}
{%                                     for asn in expand.get('asn_list', []) %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} then as-path-prepend {{asn}}
{%                                     endfor %}
{%                                 endif %}
{%                             endif %}{# /* as_path in update of term_action_list */ #}
{%                         endif %}{# /* update in term_action_list */ #}
{%                         if texternal == 'ospf-type-1' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} then external type 1
{%                         elif texternal == 'ospf-type-2' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} then external type 2
{%                         endif %}
{%                         if tas_path_expand != '' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} then as-path-expand "{{tas_path_expand}}"
{%                         endif %}
{%                         if tas_path_prepend != '' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} then as-path-expand "{{tas_path_prepend}}"
{%                         endif %}
{%                         if term_action != '' %}
set groups {{cfg_group}} policy-options policy-statement {{rp_name}} term {{tname}} then {{term_action}}
{%                         endif %}{# /* action valid */ #}
{%                     endif %}{# /* Then clause taction */ #}
{%                 endif %}{# /* if term_match_condition and term_action_list valid */ #}
{%             endfor %}{# /* for each terms */ #}
{%         endif %}{# /* valid routing_policy_entries */ #}
{%     endfor %}{# /* routing_policies */ #}
{%     for ribg in device_abstract_config.get('rib_groups', []) %}
{%         set rname = ribg.get('name', '') %}
{%         set ns_first = namespace(found=true) %}
{%         for rimport_rib in ribg.get('import_rib', []) %}
{%             if rimport_rib == 'inet.0' %}
set groups {{cfg_group}} routing-options rib-groups {{rname}} import-rib inet.0
{%             else %}
set groups {{cfg_group}} routing-options rib-groups {{rname}} import-rib {{rimport_rib}}.inet.0
{%             endif %}{# /* set import-rib */ #}
{%             if ns_first.found == true %}
{%                 set ns_first.found = false %}
{%                 if ribg.get('interface_routes', false) == true %}
{%                     if rimport_rib == 'inet.0' %}
set groups {{cfg_group}} routing-options interface-routes rib-group inet {{rname}}
{%                     else %}
set groups {{cfg_group}} routing-instances {{rimport_rib}} routing-options interface-routes rib-group inet {{rname}}
{%                     endif %}
{%                 endif %}
{%                 if ribg.get('static', false) == true %}
{%                     if rimport_rib == 'inet.0' %}
set groups {{cfg_group}} routing-options static rib-group {{rname}}
{%                     else %}
set groups {{cfg_group}} routing-instances {{rimport_rib}} routing-options static rib-group {{rname}}
{%                     endif %}
{%                 endif %}
{%                 if ribg.get('bgp', false) == true %}
{%                     if rimport_rib == 'inet.0' %}
set groups {{cfg_group}} protocols bgp family inet unicast rib-group {{rname}}
{%                     else %}
set groups {{cfg_group}} routing-instances {{rimport_rib}} protocols bgp family inet unicast rib-group {{rname}}
{%                     endif %}
{%                 endif %}
{%             endif %}{# /* set rib group to only src LR routing instance (first entry) */ #}
{%         endfor %}
{%         for rimport_policy in ribg.get('import_policy', []) %}
set groups {{cfg_group}} routing-options rib-groups {{rname}} import-policy {{rimport_policy}}
{%         endfor %}
{%     endfor %}{# /* rib-groups */ #}
