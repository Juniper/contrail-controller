---

- name: "Execute 'show igmp snooping membership {{ group }}' and 'show multicast snooping route extensive {{ group }} on {{ inspected_device_name }}'"
  juniper_junos_command:
    commands:
      - "show igmp snooping membership {{ group }}"
      - "show multicast snooping route extensive group {{ group }}"
    display: xml
    provider:
      host: "{{ physical_router_response.obj.physical_router_management_ip }}"
      username: "{{ inspected_device_user }}"
      password: "{{ inspected_device_password }}"
      port: 22
      timeout: "{{ JUNOS_COMMAND_TIMEOUT|int }}"
  register: server_leaf_query_response

- name: Print server_leaf_query_response
  debug:
    var: server_leaf_query_response

- name: "Fetch multicast statistics from the results for the device {{ inspected_device_name }}"
  set_fact:
    multicast_statistics: "{{ server_leaf_query_response.results[1].parsed_output }}"

- name: "Fetch downstream interface name(s) from multicast_statistics"
  set_fact:
    downstream_interface_list: "{{ multicast_statistics['multicast-route-information']['route-family']['l2ng-multicast-route']['l2ng-downstream-interface-names']['interface-name'] }}"
  when: multicast_statistics['multicast-route-information'] is defined

- name: "Give downstream_interface_list consistent structure (Junos returns single element or list with multiple elements)"
  set_fact:
    downstream_interface_list: "{{ [downstream_interface_list] }}"
  when: downstream_interface_list is defined and downstream_interface_list | type_debug != 'list'

- name: "Create new entry for egress list (device: {{ inspected_device_name }})"
  set_fact:
    new_entry:
      device_name: "{{ inspected_device_name }}"
      source_address: "{{ multicast_statistics['multicast-route-information']['route-family']['l2ng-multicast-route']['multicast-source-address'] }}"
      downstream_interface: "{{ downstream_interface_list }}"
      kbps: "{{ multicast_statistics['multicast-route-information']['route-family']['l2ng-multicast-route']['forwarding-rate-kilobytes'] }}"
      pps: "{{ multicast_statistics['multicast-route-information']['route-family']['l2ng-multicast-route']['forwarding-rate-packets'] }}"
  when: multicast_statistics['multicast-route-information'] is defined

- name: "Add new entry to egress_list"
  set_fact:
    egress_list: "{{ egress_list + [new_entry] }}"
  when: new_entry is defined
