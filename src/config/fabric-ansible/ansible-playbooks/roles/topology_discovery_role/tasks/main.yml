---
# tasks file for topology_discovery_role

- set_fact:
    job_ctx: "{{job_ctx|combine(percent_init_dict)}}"

- name: check to see if the ansible file for the vendor and family exists
  stat:
    path: "../../{{prouter_vendor}}_device_roles/tasks/{{prouter_family}}_command.yml"
  register: p

- name: Execute commands on device
  include_tasks: "../../{{prouter_vendor}}_device_roles/tasks/{{prouter_family}}_command.yml"
  when: p.stat.exists

# this is assuming device family is of the form: vendor_os-device_family. Ex: junos-qfx
- name: Execute commands on device from default location
  block:
    - set_fact:
        prouter_family_mod: "{{ prouter_family.split('-')[0] | lower }}"
    - include_tasks: "../../{{prouter_vendor}}_device_roles/tasks/{{prouter_family_mod}}_command.yml"
  when: p.stat.exists == False

- name: Update job log with percentage
  include_tasks: percentage_update.yml
  vars:
    current_index: 1
    jl_message: "Obtained topology information from the {{prouter_vendor}} device; starting to parse information ..."

- name: parse lldp info obtained to get remote system information
  set_fact:
    topology_discovery_result: "{{job_ctx | topology_discovery(prouter_fqname, prouter_vendor, prouter_family, device_info) }}"

- name: Handle any exception or error cases
  include_tasks: error_handler.yml
  when: topology_discovery_result.status == 'failure'
  vars:
    op_err_message: "Unable to discover topology due to the following error: {{ topology_discovery_result.error_msg }}"
    jl_err_message: "Failed to discover topology due to error: {{ topology_discovery_result.error_msg }}. Here is the topology_discovery_log: {{topology_discovery_result.topology_discovery_log}}"

- name: Set the topology_discovery response
  set_fact:
    topology_discovery_resp: "{{topology_discovery_result.topology_discovery_resp}}"

- name: Update job log with percentage
  include_tasks: percentage_update.yml
  vars:
    current_index: 2
    jl_message: "Created {{topology_discovery_resp.lldp_neighbors_success_names|length}} links between the physical interfaces on {{prouter_vendor}} device and its neighbors"
    jl_details: {"discovered_neighbors": "{{topology_discovery_resp.lldp_neighbors_success_names}}",
                 "skipped_neighbors": "{{topology_discovery_resp.lldp_neighbors_failed_info}}"}
