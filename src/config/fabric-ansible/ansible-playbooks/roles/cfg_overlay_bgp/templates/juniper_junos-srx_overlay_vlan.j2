{% set ri = device_abstract_config.get("routing_instances", []) %}
{% set bgp = device_abstract_config.get("bgp", []) %}

{% for i in range(ri | length) %}
set groups {{cfg_group}} routing-instances {{ri[i].get("name")}} instance-type {{ri[i].get("routing-instance-type")}}
{%     set intf = ri[i].get("interfaces",[]) %}
{%     for j in range(intf | length) %}
set groups {{cfg_group}} routing-instances {{ri[i].get("name")}} interface {{intf[j].get("name")}}
{%     endfor %}
set groups {{cfg_group}} routing-instances {{ri[i].get("name")}} routing-options aggregate route 0.0.0.0/0 policy aggregate_contribute
{% endfor %}

{% for i in range(bgp | length) %}
{%     set families = bgp[i].get("families",[]) %}
{%     set rib_groups = bgp[i].get("rib-groups", []) %}
{%     set peers = bgp[i].get("peers", []) %}
set groups {{cfg_group}} routing-instances {{ri[i].get("name")}} protocols bgp family {{families[0]}} unicast rib-group {{rib_groups[0]}}
set groups {{cfg_group}} routing-instances {{ri[i].get("name")}} protocols bgp group {{bgp[i].get("name")}} type {{bgp[i].get("type")}} 
set groups {{cfg_group}} routing-instances {{ri[i].get("name")}} protocols bgp group {{bgp[i].get("name")}} local-address {{bgp[i].get("ip-address")}} 
set groups {{cfg_group}} routing-instances {{ri[i].get("name")}} protocols bgp group {{bgp[i].get("name")}} export from_aggregate
set groups {{cfg_group}} routing-instances {{ri[i].get("name")}} protocols bgp group {{bgp[i].get("name")}} local-as {{bgp[i].get("autonomous-system")}}
{%     for j in range(peers | length) %}
set groups {{cfg_group}} routing-instances {{ri[i].get("name")}} protocols bgp group {{bgp[i].get("name")}} neighbor {{peers[j].get("ip-address")}} description "{{peers[j].get("comment")}}"
set groups {{cfg_group}} routing-instances {{ri[i].get("name")}} protocols bgp group {{bgp[i].get("name")}} neighbor {{peers[j].get("ip-address")}} peer-as {{peers[j].get("autonomous-system")}}
{%     endfor %}
{% endfor %}

{% for i in range(bgp | length) %}
{%     set rib_groups = bgp[i].get("rib-groups", []) %}
{%     for j in range(ri | length) %}
set groups {{cfg_group}} routing-options rib-groups {{rib_groups[0]}} import-rib {{ri[j].get("name")}}.inet.0
{%     endfor %}
{% endfor %}
