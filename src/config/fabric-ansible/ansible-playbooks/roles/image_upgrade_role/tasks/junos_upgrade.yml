- name: JOB LOGS
  job_objectlog:
    message: "Upgrade device {{pr_fqname}}, Image name: {{filename}}. Starting image upgrade on the device. It may take 10 to 20 mins."
    status: 1
    job_template_fqname: "{{job_template_fqname}}"
    job_execution_id: "{{job_execution_id}}"
    config_args: "{{config_args}}"

- name: Execute a basic Junos software upgrade.
  block:
    - juniper_junos_software:
        provider:
          host: "{{pr_host}}"
          user: "{{pr_user}}"
          passwd: "{{pr_password}}"
          port: 22
        remote_package: "{{enc_tempurl}}"
      register: junos_response
    #  ignore_errors: True
  rescue:
    - include_tasks: error_handler.yml
      vars:
        op_err_message: "Unable to upgrade image on the device. Junos upgrade task failed with exception. {{junos_response.msg}}"
        results: |
          {
            "prouter_uuid": "{{prouter_uuid}}",
            "image_uuid": "{{image_uuid}}",
            "msg": "Image upgrade task failed"
          }
        jl_err_message: "Unable to upgrade image on the device. Junos upgrade task failed with exception. {{junos_response.msg}}"



- name: Print the complete response.
  debug:
    var: junos_response

- name: JOB LOGS
  job_objectlog:
    message: "Upgrade device {{pr_fqname}}, Image name: {{filename}}. Image upgrade task completed on this device: {{junos_response}}"
    status: 1
    job_template_fqname: "{{job_template_fqname}}"
    job_execution_id: "{{job_execution_id}}"
    config_args: "{{config_args}}"

- name: Fail if Junos upgrade response failed
  include_tasks: error_handler.yml
  when: "junos_response.failed == true"
  vars:
    op_err_message: "Unable to upgrade image on the device. Junos upgrade task failed."
    results: |
      {
        "prouter_uuid": "{{prouter_uuid}}",
        "image_uuid": "{{image_uuid}}",
        "msg": "Image upgrade task failed"
      }
    jl_err_message: "Unable to upgrade image on the device. Junos upgrade task failed."

