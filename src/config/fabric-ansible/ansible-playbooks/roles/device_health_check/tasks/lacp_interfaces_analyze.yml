---

- name: Convert to list if dict
  set_fact:
    lacp_information_list: [ "{{lacp_information}}"  ]
  when: lacp_information is mapping

- name: Print the lacp information list
  debug:
    msg="{{lacp_information_list}}" verbosity=1

- name: Set the name of the multihomed interface testing
  set_fact:
    multihomed_interface: "{{item.1}}"

- name: Set the device name
  set_fact:
    device_name: "{{item.0.name}}"
  when: itr_check is defined and itr_check == "peer_check"

- name: Get the status of each interface in the multihomed list
  set_fact:
    status: "{{item['lacp-interface-information']['lag-lacp-protocol']['lacp-mux-state']}}"
  with_items:
    - "{{lacp_information_list}}"
  when:
    - multihomed_interface == "{{item['lacp-interface-information']['lag-lacp-protocol']['name']}}"

- block:
    - name: Handle the case when status None
      set_fact:
        lacp_error_msg: The listed multi-homed interface {{multihomed_interface}} for the device {{device_name}} does not seem to be configured with lacp.

    - name: Append to the errors list
      set_fact:
        errors_list: "{{ errors_list + [ lacp_error_msg ] }}"

    - name: Set the multi-homed error flag
      set_fact:
        multi_homed_error_flag: True
  when: status == ""

- block:
    - name: Print the status if the interface is up
      debug:
        msg: "The multi-homed interface {{multihomed_interface}} for the device {{device_name}} is up. The status is {{status}}"
      when: status == "Collecting distributing"

    - name: Handle the case when the interface is not up
      debug:
        msg: "The multi-homed interface {{multihomed_interface}} for the device {{device_name}} seems to be down. The upgrade will not be hitless.Traffic might get affected"
      when: status != "Collecting distributing" and abort_upon_failure == False

    - block:
        - name: Handle the case when status None
          set_fact:
            lacp_error_msg: The multi-homed interface {{multihomed_interface}} for the device {{device_name}} seems to be down. The upgrade will not be hitless.The status is {{status}}

        - name: Append to the errors list
          set_fact:
            errors_list: "{{ errors_list + [ lacp_error_msg ] }}"

        - name: Set the multi-homed error flag
          set_fact:
            multi_homed_error_flag: True
      when: status != "Collecting distributing"

    - name: Set status back to None
      set_fact:
        status: ""
  when: status is defined and status != ""
