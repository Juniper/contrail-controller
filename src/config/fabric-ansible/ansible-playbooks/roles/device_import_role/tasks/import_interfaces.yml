- name: Update pb_input
  set_fact:
    pb_input: "{{pb_input | combine({'interface_filters': [{'op': 'regex', 'expr': '^xe|^ge|^et|^fxp|^xle|^fc|^fte|^lo0'}] })}}"

- name: Execute commands on device
  include_tasks: "../../{{prouter_vendor}}_device_roles/tasks/{{prouter_os}}_command.yml"

- name: Update job log with percentage
  include_tasks: percentage_update.yml
  vars:
    current_index: 2
    jl_message: "Obtained interface information from the {{prouter_vendor}} device; starting import ..."

- name: Get the pattern object
  set_fact:
    pattern_obj: |
      {%- set regex_list = []                                                           %}
      {%- for filter in pb_input.get('interface_filters', {})                           %}
      {%-     if filter.get('op') == "regex"                                            %}
      {%-         set x=regex_list.append(filter.get('expr', None))                     %}
      {%-     endif                                                                     %}
      {%- endfor                                                                        %}
      {
       "regex_list": {{regex_list|to_json}}
      }

- name: get the regex str separated by |
  set_fact:
    regex_str: "{{pattern_obj.regex_list|join('|')}}"

- name: Onboard interfaces
  set_fact:
    device_import_result: "{{job_ctx.get('auth_token') | device_import(prouter_name, prouter_vendor, prouter_family, device_info, regex_str) }}"

- name: Handle any exception or error cases
  include_tasks: error_handler.yml
  when: device_import_result.status == 'failure'
  vars:
    op_err_message: "Unable to onboard interfaces due to the following error: {{ device_import_result.error_msg }}"
    jl_err_message: "Failed to onboard interfaces due to error. Here is the device_import_log: {{device_import_result.device_import_log}}"

- name: Set the device_import response
  set_fact:
    device_import_resp: "{{device_import_result.device_import_resp}}"

- name: Update job log with percentage
  include_tasks: percentage_update.yml
  vars:
    current_index: 3
    jl_message: "Imported {{device_import_resp.phy_intfs_success_names|length}} physical interfaces and {{device_import_resp.log_intfs_success_names|length}} logical interfaces.{{device_import_resp.dataplane_ip_upd_resp}}{{device_import_resp.dataplane_ip}}"
    jl_details: {
                  "imported_phy_intfs": "{{device_import_resp.phy_intfs_success_names}}",
                  "imported_log_intfs": "{{device_import_resp.log_intfs_success_names}}",
                  "failed_phy_intfs": "{{device_import_resp.phy_intfs_failed_names}}",
                  "failed_log_intfs": "{{device_import_resp.log_intfs_failed_names}}"
                }
